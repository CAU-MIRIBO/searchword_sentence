<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Come Come Come</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>

</head>
<body>
    <h2>Work it Work it >> plz : </h2>
    <button type="button" id="btn_data" style="WIDTH: 120pt; HEIGHT: 20pt">Push Push Baby</button> 
    <br>
    <input type="text" id="url11" placeholder="URL" style="WIDTH: 100pt; HEIGHT: 15pt">
    <br>
    <input type="text" id="search" placeholder="검색어" style="WIDTH: 100pt; HEIGHT: 15pt">
   
    <p>&nbsp;</p>
    <!-- data에 new 한 html 출력 -->
    <div id="data1"></div>
    <div id="data2"></div>


    <script>
        
        var output;     // default html output
        var url1;       // url
        var search_word;    //search_word
        
        $("#btn_data").click(function(){
            // 버튼을 클릭하면 url11랑 search_word에 각각 url이랑 검색어 가져오기
            url1 = $('#url11').val();
            search_word=$('#search').val();
            
            // load_ajax에선 url을 통해서 화면에 띄울 새로운 검색어 문장 html 생성해서 띄워준다.
            load_ajax();

        });        
        // 가장 중요한 함수!!
        function load_ajax() {

            try{
                $.ajax({
                    type: 'GET',
                    url:"https://proxyformiribo.herokuapp.com/"+url1,
                    async: true,
                    //data: 'JSONP',
                    success: function(result){
                        
                        console.log("[requestPostBodyJson] : [result] : Success");
                        output=result;
                        if (!!search_word){
                            //output 1: show keyword paragraph
                            var search_sen=find_search_word();
                            try{
                                $("#data1").html(search_sen);
                            }catch{
                                console.log('search word display error catch')
                            }
                            search_word='';
                        }
                         
                        var display_html;
                        //case 1 - stackoverflow 
                        if(url1.includes('stackoverflow.com/questions/')){
                            var display_html=stackoverflow_filtering();
                        }
                        //case 2 - quora
                        else if(url1.includes('https://www.quora.com/')){
                            quora_filtering()
                        }
                         //case 3 - all case
                        else{
                            //just use output
                            display_html=output;
                        }
                        try{
                            $("#data2").html(display_html);
                        }catch{
                            console.log('all display error catch')
                        }
                        
                       

                    },
                    error : function(e){
                        //alert(e.responseText)
                        console.log(e);
                        console.log("[requestPostBodyJson] : [error] : Fail >> "+e.statusText);    				
                    },
                    complete : function(data, textStatus){
                        console.log("[requestPostBodyJson] : [complete]");
                    }
                });
            } catch (e){
                console.log(e.message);
            }
        }

        // stackoverflow page special treatment
        function stackoverflow_filtering(){

            let parser=new DOMParser();
            const doc=parser.parseFromString(output, 'text/html');
           
            cookie_container=doc.getElementsByClassName('ff-sans ps-fixed z-nav-fixed ws4 sm:w-auto p32 sm:p16 bg-black-750 fc-white bar-lg b16 l16 r16 js-consent-banner');
            while(cookie_container.length>0){
                cookie_container[0].parentNode.removeChild(cookie_container[0])
            }
            header_container=doc.getElementsByClassName('s-topbar ps-fixed t0 l0 js-top-bar');
            while(header_container.length>0){
                header_container[0].parentNode.removeChild(header_container[0])
            }
            survey_container=doc.getElementsByClassName('d-flex jc-space-between wmx12 mx-auto px16 py8');
            while(survey_container.length>0){
                survey_container[0].parentNode.removeChild(survey_container[0])
            }

            filtered_html=doc.documentElement;

            //$("#data2").html(filtered_html);
            
            return filtered_html; 
        }

        // Quora ㅈ망 어쩌지.. 안되는디...
        function quora_filtering(){
            window.location.href=url1;
            
        }

        // default
        function show_page(){
            //let parser=new DOMParser();
            //const doc=parser.parseFromString(output, 'text/html');

            //text_tags='body';
            //text_container=doc.querySelectorAll(text_tags);
            //text_container=doc.getElementsId("root");
            //console.log(text_container);
            //text_html=text_container[0].innerHTML;
            //console.log(text_html);
            
            //console.log(text_container.documentElement);

            //mainpage=text_container.getElementsByClassName('q-text qu-dynamicFontSize--regular qu-display--flex qu-px--large qu-pb--large qu-flexDirection--row PageContentsLayout___StyledText-d2uxks-0 ioqSAj');
            //console.log(mainpage)
            try{
                $("#data2").html(output);
            }catch{
                console.log('display error catch')
            }
            return output;
            
        }

        
        
        // 가져온 html 안에 검색어가 있는지 확인쓰
        function find_search_word(){

            
            console.log(search_word);
            const words=search_word.split(' ');

            let parser=new DOMParser();
            const doc=parser.parseFromString(output, 'text/html');
            
            // text를 포함한 태그 찾기
            text_tags='br, p, span, h1, h2, h3, h4, strong, em, blockquote, code, li';
            text_container=doc.querySelectorAll(text_tags);
            
            // innerText =="" 인거 빼기
            inner_container=[];
            for (var i=0; i<text_container.length; i++){
                if (text_container[i].innerText!=""){
                    inner_container.push(text_container[i]);
                }
            }

            // match 되는 element 요소들 찾기
            match_element=[]
            //try{
                for (var i=0; i<inner_container.length; i++){
                    for (var j=0; j<words.length; j++){
                        if (inner_container[i].innerText.toLowerCase().includes(words[j].toLowerCase())){

                            new_html=use_sentence_original_html(inner_container[i], words[j]);
                            //new_html=make_new_sentence_html(inner_container[i], words[j]);
                            
                            match_element.push(new_html+'<br>');
                        }
                    }
                }
            //} catch{
                //console.log('Error in matching for oop')
            //}
            match_element.push('mark { background-color: red; }');
            //<span style="background-color: #DAA"></span>
            return match_element
       }
        
        // 웹사이트의 html 속성 그대로 가져와서 쓰기 -가끔 관종 html 엄청 거슬림
        function use_sentence_original_html(i_container, word1){
            match_html=i_container.innerHTML;
            
            var english=/^[A-Za-z0-9]*$/;
            if (english.test(word1)){     // 검색어가 영어면 일케 처리 - 대소문자 달라도 강조처리 해줘야하니까
                reg=new RegExp(word1, 'gi');
                //console.log(reg);
                new_html=match_html.replace(reg, function(str){
                return "<mark style=\"background-color:#FAE5D3\">"+str+"</mark>"    // 여기서 강조처리- 다른 강조로 바꾸기 가능
            });
            }
            else{ // 검색어가 한국어이면 대소문자 노상관
                highlight_mark="<mark style=\"background-color:#FAE5D3\">"+word1+"</mark>";  // 여기서 강조처리- 다른 강조로 바꾸기 가능
                new_html=match_html.replace(word1, highlight_mark)
            }
            return new_html
        }

        // 긁어온 검색어 문장 텍스트로 html 재구성
        function make_new_sentence_html(i_container, word2){
            match_html=i_container.innerText;
        
            var english=/^[A-Za-z0-9]*$/;
            if (english.test(word2)){     // 영어 검색어
                reg=new RegExp(word2, 'gi');
                //console.log(reg);
                new_html=match_html.replace(reg, function(str){
                return "<b>"+str+"</b>"     // 여기서 강조처리- 다른 강조로 바꾸기 가능
                });
                new_html=new_html;
            }
            else{   // 한국어 검색어
                highlight_mark="<b>"+word2+"</b>";    // 여기서 강조처리- 다른 강조로 바꾸기 가능
                new_html=match_html.replace(word2, highlight_mark)
            }
            return new_html
        }

        // 쓸데는 없지만 일단 언젠간 사용할 수도 있는 함수
        function loadURL(){
            var url="https://stackoverflow.com/questions/51861577/python-list-function-or-list-comprehension";

            var xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            xmlhttp.open("GET", url1.value, "false");
            xmlhttp.send();
            document.all.output.innerText=xmlhttmp.responseText;
            alert(xmlhttmp.responseText);
        }
        function loading(){
            window.location.href=url1;
           
        }

    </script>
</body>
</html>